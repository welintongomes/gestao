<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Controle de Servi√ßos</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
            justify-content: center;
        }

        .tab {
            padding: 15px 30px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #666;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .tab:hover {
            color: #667eea;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Sections responsivas */
        .section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        input,
        select {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border 0.3s;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: #667eea;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        .btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        /* Cards responsivos */
        .card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            gap: 10px;
            flex-wrap: wrap;
        }

        .card-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
            word-break: break-word;
        }

        .card-info {
            color: #666;
            margin: 8px 0;
            font-size: 0.95em;
        }

        /* Items responsivos */
        .produto-item,
        .servico-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .produto-item input,
        .servico-item input {
            width: 100px;
            margin-bottom: 0;
            flex: 1;
            min-width: 80px;
        }

        .produto-item select,
        .servico-item select {
            flex: 2;
            margin-bottom: 0;
            min-width: 150px;
        }

        .produtos-list {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
            font-size: 1.1em;
        }

        /* Barra de pesquisa responsiva */
        .search-container {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 15px;
            position: relative;
            width: 100%;
        }

        #searchInput,
        #searchAtendimentos {
            flex: 1;
            padding: 10px 35px 10px 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 14px;
            width: 100%;
        }

        #clearSearch,
        #clearAtendimentos {
            position: absolute;
            right: 10px;
            background: transparent;
            border: none;
            font-size: 18px;
            cursor: pointer;
            display: none;
            color: #888;
        }

        #clearSearch:hover,
        #clearAtendimentos:hover {
            color: #000;
        }

        /* Responsividade para telas m√©dias */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 20px;
                border-radius: 10px;
            }

            h1 {
                font-size: 1.8em;
            }

            h2 {
                font-size: 1.3em;
            }

            .tab {
                padding: 12px 20px;
                font-size: 14px;
            }

            .section {
                padding: 15px;
            }

            .card {
                padding: 15px;
            }

            .card-title {
                font-size: 1.1em;
            }

            .card-info {
                font-size: 0.9em;
            }

            .btn {
                padding: 10px 20px;
                font-size: 14px;
            }

            .produto-item,
            .servico-item {
                flex-direction: column;
                align-items: stretch;
            }

            .produto-item input,
            .servico-item input,
            .produto-item select,
            .servico-item select {
                width: 100%;
                min-width: 100%;
            }
        }

        /* Responsividade para telas pequenas */
        @media (max-width: 480px) {
            body {
                padding: 5px;
            }

            .container {
                padding: 15px;
                border-radius: 8px;
            }

            h1 {
                font-size: 1.5em;
                margin-bottom: 10px;
            }

            h2 {
                font-size: 1.2em;
                margin-bottom: 15px;
            }

            .tab {
                padding: 10px 15px;
                font-size: 13px;
            }

            .section {
                padding: 12px;
            }

            .card {
                padding: 12px;
            }

            .card-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .card-title {
                font-size: 1em;
            }

            .card-info {
                font-size: 0.85em;
            }

            input,
            select {
                padding: 10px;
                font-size: 14px;
            }

            .btn {
                padding: 10px 15px;
                font-size: 14px;
            }

            .btn-danger {
                padding: 6px 12px;
                font-size: 13px;
            }

            .button-group {
                flex-direction: column;
                width: 100%;
            }

            .button-group .btn {
                width: 100%;
            }
        }
    </style>
</head>

<body>
    <div class="container">


        <div class="tabs">
            <button class="tab active" onclick="showTab('produtos')">Produtos</button>
            <button class="tab" onclick="showTab('servicos')">Servi√ßos</button>
            <button class="tab" onclick="showTab('atendimentos')">Atendimentos</button>
        </div>

        <div id="produtos" class="tab-content active">
            <div class="section">
                <h2>Cadastrar Produto</h2>
                <input type="text" id="produto-nome" placeholder="Nome do Produto">
                <input type="number" id="produto-preco" placeholder="Pre√ßo" step="0.01">
                <button class="btn" onclick="adicionarProduto()">Adicionar Produto</button>
            </div>
            <!-- produtos -->
            <div class="section">
                <h2>Produtos Cadastrados</h2>
                <!-- Barra de pesquisa -->
                <div class="search-container">
                    <input type="text" id="searchInput" placeholder="Pesquisar produtos...">
                    <button id="clearSearch">&times;</button>
                </div>

                <!-- Lista de produtos -->
                <div id="lista-produtos"></div>

                <div
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-direction: column;">
                    <h1>Gest√£o de Servi√ßos</h1>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn" onclick="exportarDados()" style="background: #4CAF50;">üì• Exportar
                            Dados</button>
                        <button class="btn" onclick="importarDados()" style="background: #FF9800;">üì§ Importar
                            Dados</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="servicos" class="tab-content">
            <div class="section">
                <h2>Criar Servi√ßo</h2>
                <input type="text" id="servico-nome" placeholder="Nome do Servi√ßo">

                <div style="margin: 15px 0;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <strong>Produtos do Servi√ßo:</strong>
                        <button class="btn" onclick="adicionarProdutoServico()">+ Adicionar Produto</button>
                    </div>
                    <div id="produtos-servico"></div>
                    <div id="custo-total-servico" style="margin-top: 10px; font-weight: bold; color: #667eea;">
                        Custo Total: R$ 0,00
                    </div>
                </div>

                <button class="btn" onclick="salvarServico()">Salvar Servi√ßo</button>
            </div>
            <!-- Servi√ßos -->
            <div class="section">
                <h2>Servi√ßos Cadastrados</h2>
                <div id="lista-servicos"></div>
            </div>
        </div>

        <div id="atendimentos" class="tab-content">
            <div class="section">
                <h2>Registrar Atendimento</h2>
                <input type="text" id="cliente-nome" placeholder="Nome do Cliente">

                <div style="margin: 15px 0;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <strong>Servi√ßos:</strong>
                        <button class="btn" onclick="adicionarServicoAtendimento()">+ Adicionar Servi√ßo</button>
                    </div>
                    <div id="servicos-atendimento"></div>
                    <div id="custo-total-atendimento" style="margin-top: 10px; font-weight: bold; color: #2196F3;">
                        Custo Total: R$ 0,00
                    </div>
                </div>

                <input type="number" id="valor-cobrado" placeholder="Valor Cobrado" step="0.01">
                <button class="btn" onclick="registrarAtendimento()">Registrar Atendimento</button>
            </div>

            <div class="section">
                <h2>Hist√≥rico de Atendimentos</h2>
                <!-- Atendimentos -->
                <div class="search-container">
                    <input type="text" id="searchAtendimentos" placeholder="Pesquisar atendimentos...">
                    <button id="clearAtendimentos">&times;</button>
                </div>
                <div id="lista-atendimentos"></div>
            </div>
        </div>
    </div>

    <script>
        let db;

        // Inicializar IndexedDB
        function initDB() {
            const request = indexedDB.open('SistemaServicosDB', 1);

            request.onerror = () => {
                console.error('Erro ao abrir banco de dados');
            };

            request.onsuccess = (event) => {
                db = event.target.result;
                carregarDados();
            };

            request.onupgradeneeded = (event) => {
                db = event.target.result;

                if (!db.objectStoreNames.contains('produtos')) {
                    db.createObjectStore('produtos', { keyPath: 'id', autoIncrement: true });
                }
                if (!db.objectStoreNames.contains('servicos')) {
                    db.createObjectStore('servicos', { keyPath: 'id', autoIncrement: true });
                }
                if (!db.objectStoreNames.contains('atendimentos')) {
                    db.createObjectStore('atendimentos', { keyPath: 'id', autoIncrement: true });
                }
            };
        }

        // Fun√ß√µes de Produtos
        function adicionarProduto() {
            const nome = document.getElementById('produto-nome').value;
            const preco = parseFloat(document.getElementById('produto-preco').value);

            if (!nome || !preco) {
                alert('Preencha todos os campos!');
                return;
            }

            const transaction = db.transaction(['produtos'], 'readwrite');
            const store = transaction.objectStore('produtos');

            store.add({ nome, preco });

            transaction.oncomplete = () => {
                document.getElementById('produto-nome').value = '';
                document.getElementById('produto-preco').value = '';
                carregarProdutos();
            };
        }

        function carregarProdutos() {
            const transaction = db.transaction(['produtos'], 'readonly');
            const store = transaction.objectStore('produtos');
            const request = store.getAll();

            request.onsuccess = () => {
                let produtos = request.result;
                const lista = document.getElementById('lista-produtos');
                const searchInput = document.getElementById('searchInput');

                if (produtos.length === 0) {
                    lista.innerHTML = '<div class="empty-state">Nenhum produto cadastrado</div>';
                    return;
                }

                // Fun√ß√£o que renderiza os produtos filtrados
                function renderProdutos(filtro = '') {
                    let filtrados = produtos.filter(p =>
                        p.nome.toLowerCase().includes(filtro.toLowerCase())
                    );

                    // Mostrar apenas os 3 √∫ltimos
                    filtrados = filtrados.slice(-3);

                    if (filtrados.length === 0) {
                        lista.innerHTML = '<div class="empty-state">Nenhum produto encontrado</div>';
                        return;
                    }

                    lista.innerHTML = filtrados.map(p => `
        <div class="card">
          <div class="card-header">
            <div class="card-title">${p.nome}</div>
            <button class="btn btn-danger" onclick="excluirProduto(${p.id})">Excluir</button>
          </div>
          <div class="card-info">Pre√ßo: R$ ${p.preco.toFixed(2)}</div>
          <input type="number" step="0.01" value="${p.preco}" 
                 onchange="atualizarPrecoProduto(${p.id}, this.value)"
                 style="margin-top: 10px;">
        </div>
      `).join('');
                }

                // Inicializa com todos
                renderProdutos();

                // Evento de pesquisa
                searchInput.addEventListener('input', () => {
                    const filtro = searchInput.value;
                    renderProdutos(filtro);

                    // Mostra/esconde bot√£o limpar
                    document.getElementById('clearSearch').style.display = filtro ? 'block' : 'none';
                });

                // Bot√£o limpar
                document.getElementById('clearSearch').addEventListener('click', () => {
                    searchInput.value = '';
                    renderProdutos();
                    document.getElementById('clearSearch').style.display = 'none';
                });

                atualizarSelectProdutos();
            };
        }


        function atualizarPrecoProduto(id, novoPreco) {
            const transaction = db.transaction(['produtos'], 'readwrite');
            const store = transaction.objectStore('produtos');
            const request = store.get(id);

            request.onsuccess = () => {
                const produto = request.result;
                produto.preco = parseFloat(novoPreco);
                store.put(produto);
                carregarProdutos();
            };
        }

        function excluirProduto(id) {
            if (!confirm('Deseja excluir este produto?')) return;

            const transaction = db.transaction(['produtos'], 'readwrite');
            const store = transaction.objectStore('produtos');
            store.delete(id);

            transaction.oncomplete = () => carregarProdutos();
        }

        // Fun√ß√µes de Servi√ßos
        function atualizarSelectProdutos() {
            const transaction = db.transaction(['produtos'], 'readonly');
            const store = transaction.objectStore('produtos');
            const request = store.getAll();

            request.onsuccess = () => {
                window.produtosDisponiveis = request.result;
            };
        }

        function adicionarProdutoServico() {
            const container = document.getElementById('produtos-servico');
            const div = document.createElement('div');
            div.className = 'produto-item';

            const select = document.createElement('select');
            select.style.flex = '1';
            select.innerHTML = '<option value="">Selecione um produto</option>' +
                window.produtosDisponiveis.map(p =>
                    `<option value="${p.id}">${p.nome} - R$ ${p.preco.toFixed(2)}</option>`
                ).join('');
            select.onchange = calcularCustoServico;

            const inputQtd = document.createElement('input');
            inputQtd.type = 'number';
            inputQtd.placeholder = 'Qtd';
            inputQtd.min = '0';
            inputQtd.step = '0.01';
            inputQtd.value = '1';
            inputQtd.onchange = calcularCustoServico;

            const btnRemover = document.createElement('button');
            btnRemover.textContent = 'Remover';
            btnRemover.className = 'btn-danger';
            btnRemover.onclick = () => {
                div.remove();
                calcularCustoServico();
            };

            div.appendChild(select);
            div.appendChild(inputQtd);
            div.appendChild(btnRemover);
            container.appendChild(div);
        }

        function calcularCustoServico() {
            const items = document.querySelectorAll('#produtos-servico .produto-item');
            let total = 0;

            items.forEach(item => {
                const select = item.querySelector('select');
                const qtd = parseFloat(item.querySelector('input').value) || 0;
                const produtoId = parseInt(select.value);

                if (produtoId) {
                    const produto = window.produtosDisponiveis.find(p => p.id === produtoId);
                    if (produto) {
                        total += produto.preco * qtd;
                    }
                }
            });

            document.getElementById('custo-total-servico').textContent =
                `Custo Total: R$ ${total.toFixed(2)}`;
        }

        function salvarServico() {
            const nome = document.getElementById('servico-nome').value;
            const items = document.querySelectorAll('#produtos-servico .produto-item');

            if (!nome) {
                alert('Digite o nome do servi√ßo!');
                return;
            }

            const produtos = [];
            let custoTotal = 0;

            items.forEach(item => {
                const select = item.querySelector('select');
                const qtd = parseFloat(item.querySelector('input').value) || 0;
                const produtoId = parseInt(select.value);

                if (produtoId && qtd > 0) {
                    const produto = window.produtosDisponiveis.find(p => p.id === produtoId);
                    if (produto) {
                        produtos.push({
                            produtoId: produto.id,
                            nome: produto.nome,
                            quantidade: qtd,
                            preco: produto.preco
                        });
                        custoTotal += produto.preco * qtd;
                    }
                }
            });

            if (produtos.length === 0) {
                alert('Adicione pelo menos um produto!');
                return;
            }

            const transaction = db.transaction(['servicos'], 'readwrite');
            const store = transaction.objectStore('servicos');

            store.add({ nome, produtos, custoTotal });

            transaction.oncomplete = () => {
                document.getElementById('servico-nome').value = '';
                document.getElementById('produtos-servico').innerHTML = '';
                document.getElementById('custo-total-servico').textContent = 'Custo Total: R$ 0,00';
                carregarServicos();
            };
        }

        let servicosCarregados = 0; // quantos j√° renderizamos
        const SERVICOS_POR_PAGINA = 2; // mostrar de 2 em 2

        function carregarServicos() {
            console.log("üì¶ Carregando servi√ßos...");

            const transaction = db.transaction(['servicos'], 'readonly');
            const store = transaction.objectStore('servicos');
            const request = store.getAll();

            request.onsuccess = () => {
                const servicos = request.result;
                const lista = document.getElementById('lista-servicos');
                const select = document.getElementById('servico-selecionado');

                // reset inicial
                lista.innerHTML = "";
                servicosCarregados = 0;

                if (servicos.length === 0) {
                    lista.innerHTML = '<div class="empty-state">Nenhum servi√ßo cadastrado</div>';
                    if (select) {
                        select.innerHTML = '<option value="">Selecione um servi√ßo</option>';
                    }
                    return;
                }

                // ordenar para mostrar os √∫ltimos primeiro
                const servicosOrdenados = servicos.reverse();

                // renderizar primeiros 2
                renderizarServicos(servicosOrdenados, lista, select, servicosCarregados, SERVICOS_POR_PAGINA);
                servicosCarregados += SERVICOS_POR_PAGINA;

                // configurar scroll infinito (s√≥ uma vez)
                if (!lista.dataset.scrollBind) {
                    lista.dataset.scrollBind = "true";
                    lista.addEventListener("scroll", () => {
                        if (lista.scrollTop + lista.clientHeight >= lista.scrollHeight - 10) {
                            renderizarServicos(servicosOrdenados, lista, select, servicosCarregados, SERVICOS_POR_PAGINA);
                            servicosCarregados += SERVICOS_POR_PAGINA;
                        }
                    });
                }
            };
        }

        function renderizarServicos(servicos, lista, select, start, limit) {
            const subset = servicos.slice(start, start + limit);

            subset.forEach(s => {
                const card = document.createElement("div");
                card.className = "card";
                card.innerHTML = `
            <div class="card-header">
                <div class="card-title">${s.nome}</div>
                <button class="btn btn-danger" onclick="excluirServico(${s.id})">Excluir</button>
            </div>
            <div class="card-info"><strong>Custo Total: R$ ${s.custoTotal.toFixed(2)}</strong></div>
            <div class="produtos-list">
                ${s.produtos.map(p => `
                    <div style="padding: 5px 0;">
                        ‚Ä¢ ${p.nome} - ${p.quantidade} unid. √ó R$ ${p.preco.toFixed(2)}
                    </div>
                `).join('')}
            </div>
        `;
                lista.appendChild(card);
            });

            if (select) {
                if (start === 0) {
                    select.innerHTML = '<option value="">Selecione um servi√ßo</option>';
                }
                subset.forEach(s => {
                    const opt = document.createElement("option");
                    opt.value = s.id;
                    opt.textContent = `${s.nome} - Custo: R$ ${s.custoTotal.toFixed(2)}`;
                    select.appendChild(opt);
                });
            }
        }




        function excluirServico(id) {
            if (!confirm('Deseja excluir este servi√ßo?')) return;

            const transaction = db.transaction(['servicos'], 'readwrite');
            const store = transaction.objectStore('servicos');
            store.delete(id);

            transaction.oncomplete = () => carregarServicos();
        }

        // Fun√ß√µes de Atendimentos
        function registrarAtendimento() {
            const cliente = document.getElementById('cliente-nome').value;
            const servicosSelecionados = document.querySelectorAll('#servicos-atendimento .servico-item');
            const valorCobrado = parseFloat(document.getElementById('valor-cobrado').value);

            if (!cliente || servicosSelecionados.length === 0 || !valorCobrado) {
                alert('Preencha todos os campos e adicione pelo menos um servi√ßo!');
                return;
            }

            const servicosIds = [];
            servicosSelecionados.forEach(item => {
                const servicoId = parseInt(item.querySelector('select').value);
                if (servicoId) servicosIds.push(servicoId);
            });

            if (servicosIds.length === 0) {
                alert('Selecione pelo menos um servi√ßo v√°lido!');
                return;
            }

            const transactionServicos = db.transaction(['servicos'], 'readonly');
            const storeServicos = transactionServicos.objectStore('servicos');

            let servicosDetalhes = [];
            let custoTotal = 0;
            let processados = 0;

            servicosIds.forEach(servicoId => {
                const request = storeServicos.get(servicoId);
                request.onsuccess = () => {
                    const servico = request.result;
                    servicosDetalhes.push({
                        nome: servico.nome,
                        custo: servico.custoTotal
                    });
                    custoTotal += servico.custoTotal;
                    processados++;

                    if (processados === servicosIds.length) {
                        const data = new Date().toLocaleString('pt-BR');
                        const transaction = db.transaction(['atendimentos'], 'readwrite');
                        const store = transaction.objectStore('atendimentos');

                        store.add({
                            cliente,
                            servicos: servicosDetalhes,
                            custoServico: custoTotal,
                            valorCobrado,
                            lucro: valorCobrado - custoTotal,
                            data
                        });

                        transaction.oncomplete = () => {
                            document.getElementById('cliente-nome').value = '';
                            document.getElementById('servicos-atendimento').innerHTML = '';
                            document.getElementById('valor-cobrado').value = '';
                            document.getElementById('custo-total-atendimento').textContent = 'Custo Total: R$ 0,00';
                            carregarAtendimentos();
                        };
                    }
                };
            });
        }

        function adicionarServicoAtendimento() {
            const transaction = db.transaction(['servicos'], 'readonly');
            const store = transaction.objectStore('servicos');
            const request = store.getAll();

            request.onsuccess = () => {
                const servicos = request.result;
                const container = document.getElementById('servicos-atendimento');
                const div = document.createElement('div');
                div.className = 'servico-item';
                div.style.cssText = 'display: flex; gap: 10px; margin-bottom: 10px;';

                const select = document.createElement('select');
                select.style.flex = '1';
                select.innerHTML = '<option value="">Selecione um servi√ßo</option>' +
                    servicos.map(s =>
                        `<option value="${s.id}">${s.nome} - R$ ${s.custoTotal.toFixed(2)}</option>`
                    ).join('');
                select.onchange = calcularCustoAtendimento;

                const btnRemover = document.createElement('button');
                btnRemover.textContent = 'Remover';
                btnRemover.className = 'btn-danger';
                btnRemover.onclick = () => {
                    div.remove();
                    calcularCustoAtendimento();
                };

                div.appendChild(select);
                div.appendChild(btnRemover);
                container.appendChild(div);
            };
        }

        function calcularCustoAtendimento() {
            const items = document.querySelectorAll('#servicos-atendimento .servico-item');
            let total = 0;

            const transactionServicos = db.transaction(['servicos'], 'readonly');
            const storeServicos = transactionServicos.objectStore('servicos');

            let processados = 0;

            items.forEach(item => {
                const select = item.querySelector('select');
                const servicoId = parseInt(select.value);

                if (servicoId) {
                    const request = storeServicos.get(servicoId);
                    request.onsuccess = () => {
                        const servico = request.result;
                        if (servico) total += servico.custoTotal;
                        processados++;
                        if (processados === items.length) {
                            document.getElementById('custo-total-atendimento').textContent =
                                `Custo Total: R$ ${total.toFixed(2)}`;
                        }
                    };
                } else {
                    processados++;
                }
            });

            if (items.length === 0) {
                document.getElementById('custo-total-atendimento').textContent = 'Custo Total: R$ 0,00';
            }
        }

        function carregarAtendimentos() {
            const transaction = db.transaction(['atendimentos'], 'readonly');
            const store = transaction.objectStore('atendimentos');
            const request = store.getAll();

            request.onsuccess = () => {
                let atendimentos = request.result;
                const lista = document.getElementById('lista-atendimentos');
                const searchInput = document.getElementById('searchAtendimentos');

                if (atendimentos.length === 0) {
                    lista.innerHTML = '<div class="empty-state">Nenhum atendimento registrado</div>';
                    return;
                }

                // Fun√ß√£o de renderiza√ß√£o
                function renderAtendimentos(filtro = '') {
                    let filtrados = atendimentos.filter(a =>
                        a.cliente.toLowerCase().includes(filtro.toLowerCase())
                    );

                    // Somente os 3 √∫ltimos
                    filtrados = filtrados.slice(-3);

                    if (filtrados.length === 0) {
                        lista.innerHTML = '<div class="empty-state">Nenhum atendimento encontrado</div>';
                        return;
                    }

                    lista.innerHTML = filtrados.map(a => `
        <div class="card">
          <div class="card-header">
            <div class="card-title">${a.cliente}</div>
            <button class="btn btn-danger" onclick="excluirAtendimento(${a.id})">Excluir</button>
          </div>
          <div class="card-info">Servi√ßos:</div>
          ${a.servicos ? a.servicos.map(s => `
              <div style="padding-left: 15px;">‚Ä¢ ${s.nome} - R$ ${s.custo.toFixed(2)}</div>
          `).join('') : `<div style="padding-left: 15px;">‚Ä¢ ${a.servico} - R$ ${a.custoServico.toFixed(2)}</div>`}
          <div class="card-info">Data: ${a.data}</div>
          <div class="card-info">Custo Total: R$ ${a.custoServico.toFixed(2)}</div>
          <div class="card-info">Cobrado: R$ ${a.valorCobrado.toFixed(2)}</div>
          <div class="card-info" style="color: ${a.lucro >= 0 ? 'green' : 'red'}; font-weight: bold;">
            Lucro: R$ ${a.lucro.toFixed(2)}
          </div>
        </div>
      `).join('');
                }

                // Inicial
                renderAtendimentos();

                // Pesquisa
                searchInput.addEventListener('input', () => {
                    const filtro = searchInput.value;
                    renderAtendimentos(filtro);

                    document.getElementById('clearAtendimentos').style.display = filtro ? 'block' : 'none';
                });

                // Limpar
                document.getElementById('clearAtendimentos').addEventListener('click', () => {
                    searchInput.value = '';
                    renderAtendimentos();
                    document.getElementById('clearAtendimentos').style.display = 'none';
                });
            };
        }


        function excluirAtendimento(id) {
            if (!confirm('Deseja excluir este atendimento?')) return;

            const transaction = db.transaction(['atendimentos'], 'readwrite');
            const store = transaction.objectStore('atendimentos');
            store.delete(id);

            transaction.oncomplete = () => carregarAtendimentos();
        }

        // Navega√ß√£o entre abas
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        // Carregar todos os dados
        function carregarDados() {
            carregarProdutos();
            carregarServicos();
            carregarAtendimentos();
        }

        //fun√ßoes para importar e exportar
        // Exportar dados
        function exportarDados() {
            const transaction = db.transaction(['produtos', 'servicos', 'atendimentos'], 'readonly');

            const produtos = transaction.objectStore('produtos').getAll();
            const servicos = transaction.objectStore('servicos').getAll();
            const atendimentos = transaction.objectStore('atendimentos').getAll();

            Promise.all([
                new Promise(resolve => produtos.onsuccess = () => resolve(produtos.result)),
                new Promise(resolve => servicos.onsuccess = () => resolve(servicos.result)),
                new Promise(resolve => atendimentos.onsuccess = () => resolve(atendimentos.result))
            ]).then(([produtosData, servicosData, atendimentosData]) => {
                const dados = {
                    produtos: produtosData,
                    servicos: servicosData,
                    atendimentos: atendimentosData,
                    dataExportacao: new Date().toISOString()
                };

                const blob = new Blob([JSON.stringify(dados, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `backup-servicos-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);

                alert('Dados exportados com sucesso!');
            });
        }

        // Importar dados
        function importarDados() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';

            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const dados = JSON.parse(event.target.result);

                        if (!dados.produtos || !dados.servicos || !dados.atendimentos) {
                            alert('Arquivo inv√°lido!');
                            return;
                        }

                        if (!confirm('Isso ir√° SUBSTITUIR todos os dados atuais. Deseja continuar?')) {
                            return;
                        }

                        const transaction = db.transaction(['produtos', 'servicos', 'atendimentos'], 'readwrite');

                        // Limpar dados existentes
                        transaction.objectStore('produtos').clear();
                        transaction.objectStore('servicos').clear();
                        transaction.objectStore('atendimentos').clear();

                        // Adicionar novos dados
                        dados.produtos.forEach(p => {
                            const { id, ...produtoSemId } = p;
                            transaction.objectStore('produtos').add(produtoSemId);
                        });

                        dados.servicos.forEach(s => {
                            const { id, ...servicoSemId } = s;
                            transaction.objectStore('servicos').add(servicoSemId);
                        });

                        dados.atendimentos.forEach(a => {
                            const { id, ...atendimentoSemId } = a;
                            transaction.objectStore('atendimentos').add(atendimentoSemId);
                        });

                        transaction.oncomplete = () => {
                            alert('Dados importados com sucesso!');
                            carregarDados();
                        };

                        transaction.onerror = () => {
                            alert('Erro ao importar dados!');
                        };

                    } catch (error) {
                        alert('Erro ao ler arquivo: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };

            input.click();
        }

        // Inicializar
        initDB();
    </script>
</body>

</html>